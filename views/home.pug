doctype html
html(lang="en")
  head
    title=pageTitle
    script(type='text/javascript' src='https://s3.amazonaws.com/mturk-public/externalHIT_v1.js')
    link(rel="stylesheet" type="text/css" href="https://button.glitch.me/css/glitch.css")
    link(rel="stylesheet" type="text/css" href="https://button.glitch.me/css/button.css")
    script(src="https://sdk.amazonaws.com/js/aws-sdk-2.218.1.min.js")
    script(src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha256-3edrmyuQ0w65f8gfBsqowzjJe2iM6n0nKciPUp8y+7E=" crossorigin="anonymous")
    // jose.min.js from assets
    script(src="https://cdn.glitch.com/15205fc5-1254-4883-99e1-556eda44f301%2Fjose.min.js?1522700865983")
    script(src="https://cdn.glitch.com/15205fc5-1254-4883-99e1-556eda44f301%2Fbase64.min.js?1522701674055")
    
    div
      h2 welcome
      
      p credentials
        pre(id="x").
          {
            loading
            loading
            loading
            loading
          }
      p id token claims
        pre(id="z") loading
      p id token
        pre(id="zz") loading
      
        
      script.
        // parse the id token out of the url. #fragments are special and survive redirects. wild.
        const hash = window.location.hash.substring(1);
        let hparams = {}
        hash.split('&').map(hk => { 
          let temp = hk.split('='); 
          hparams[temp[0]] = temp[1] 
        });
        console.log(hparams);       
        
        $("#zz").text(hparams.id_token)
        // https://stackoverflow.com/questions/28100601/decode-url-safe-base64-in-javascript-browser-side
        const token_parts = hparams.id_token.split('.')
        
        const decoded_id = Base64.decode(token_parts[1] + "===")
        $("#z").text(JSON.stringify(JSON.parse(decoded_id), null, 2))
        
        AWS.config.region = '#{aws_region}';
      
        const ci = new AWS.CognitoIdentity();
        const p1 = {
          IdentityPoolId: '#{aws_identity_pool_id}',
          Logins: {
            'cognito-idp.#{aws_region}.amazonaws.com/#{aws_user_pool_id}': hparams.id_token,
          }
        };
        
        ci.getId(p1, function(err, data) {
          if (err) {
            $("#x").text("failed to getId: " + err);
            $("#z").text("n/a");
            console.error(err, err.stack);
          }
          else {
            console.log(JSON.stringify(data));
            const p2 = {
              IdentityId: data.IdentityId,
              Logins: {
                'cognito-idp.#{aws_region}.amazonaws.com/#{aws_user_pool_id}': hparams.id_token,
              }
            };
            ci.getCredentialsForIdentity(p2, (err, data) => {
              if (err) {
                $("#x").text("failed to getCredentialsForIdentity: " + err);
                $("#z").text("n/a");
                console.error(err, err.stack);
              }
              else {
                $("#x").text(JSON.stringify(data.Credentials, null, 2));
                console.log(JSON.stringify(data, null, 2));
              }
            });
          }
        });

